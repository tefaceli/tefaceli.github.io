<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ecuadorians' deportations from the U.S.</title>

    <!-- Google fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://unpkg.com/scrollama"></script>

    <script>            
      d3.csv("deport_data.csv")
        .then(data => {

            console.log(data)

            let svg;

            function drawSquares(data) {
                d3.select("#svg-chart").select("svg").remove(); // clear previous

                const container = d3.select("#svg-chart");
                const width = container.node().getBoundingClientRect().width;
                const height = window.innerHeight;

                const totalSquares = data.length;

                // Estimate square size to fill full height
                let columns = Math.floor(Math.sqrt(totalSquares * width / height));
                columns = Math.max(columns, 1);
                let rows = Math.ceil(totalSquares / columns);
                let squareSize = Math.floor(Math.min(width / columns, height / rows));

                // If squareSize too small, reduce columns
                while (squareSize < 4 && columns > 1) {
                    columns -= 1;
                    rows = Math.ceil(totalSquares / columns);
                    squareSize = Math.floor(Math.min(width / columns, height / rows));
                }

                const spacing = 1;
                const svgWidth = columns * (squareSize + spacing);
                const svgHeight = rows * (squareSize + spacing);

                svg = container
                    .append("svg")
                    .attr("width", svgWidth)
                    .attr("height", svgHeight)
                    .style("display", "block")
                    .style("margin", "0 auto");

                svg.selectAll("rect")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("x", (d, i) => (i % columns) * (squareSize + spacing))
                    .attr("y", (d, i) => Math.floor(i / columns) * (squareSize + spacing))
                    .attr("width", squareSize)
                    .attr("height", squareSize)
                    .attr("fill", "#999");

                return svg;
            }


            d3.select('#svg-chart').selectAll('svg').remove();
            drawSquares(data);

            function showCriminals() {
                svg.selectAll('rect')
                    .transition()
                    .duration(500)
                    .attr('fill', d => {
                        const status = d.case_criminality?.trim();
                        if (status === '1 Convicted Criminal') return '#e63946';
                        if (status === '2 Pending Criminal Charges') return '#f1c40f';
                        return 'lightgrey';
                    });
            }

            function showWomen() {
                svg.selectAll('rect')
                    .transition()
                    .duration(500)
                    .attr('fill', d => {
                        const status = d.gender?.trim();
                        if (status === 'Female') return '#9d4edd';
                        return 'lightgrey';
                    });
            }

            function showAgeGroups() {
                svg.selectAll('rect')
                    .transition()
                    .duration(500)
                    .attr('fill', d => {
                        const status = d.age_group?.trim();
                        if (status === '21-30') return '#264653';
                        if (status === '31-40') return '#48cae4';
                        return 'lightgrey';
                    });
            }

            // Start scrollama
            const scrolly = d3.select("#scroll-content");
            const figure = scrolly.select("#svg-chart");
            const step = scrolly.selectAll(".step"); 

            // initialize the scrollama
            const scroller = scrollama();

            // generic window resize listener event
            function handleResize() {
                var stepH = Math.floor(window.innerHeight * 0.75);
                step.style("height", stepH + "px");

                var figureHeight = Math.min(window.innerHeight * 0.8, 640);
                var figureMarginTop = (window.innerHeight - figureHeight) / 2;

                figure
                    .style("height", figureHeight + "px")
                    .style("top", figureMarginTop + "px")
                    .style("width", "100%")
                    .style("max-width", "640px")
                    .style("margin", "0 auto");

                drawSquares(data); // this will reset the svg variable

                scroller.resize();
            }

            // scrollama event handlers
            function handleStepEnter(response) {

                // add color to current step only
                step.classed("is-active", function (d, i) {
                    return i === response.index;
                });

                // update graphic based on step
                if (response.index == 0) {
                    showCriminals()
                } else if (response.index == 1) {
                    showAgeGroups()
                } else if (response.index == 2) {
                    showWomen()
                }
            }

            function init() {

                // 1. force a resize on load to ensure proper dimensions are sent to scrollama
                handleResize();

                // 2. bind scrollama event handlers (this can be chained like below)

                scroller
                    .setup({
                    step: "#scroll-content .step",
                    offset: 0.33,
                    debug: false
                    })
                    .onStepEnter(handleStepEnter);

                // 3. watch for window resizing
                window.addEventListener('resize', handleResize);
            }

            // kick things off
            init();

        })

    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-size: 20px;
            font-family: Georgia, 'Times New Roman', Times, serif;
            text-rendering: optimizeLegibility;
        }

        .content {
            max-width: 640px;
            margin: 0 auto;
        }

        .header {
            padding: 3em 0;
        }

        a {
            color: #f05349;
        }

        .footer {
            background: #f4f4f4;
            text-align: center;
            font-size: 0.8em;
            margin-top: 4em;
            padding: 4em 0;
        }

        figure {
            margin: 0;
            padding-bottom: 1.2em;
        }

        figcaption {
            font-size: 0.8em;
            text-align: center;
            margin-top: 0.5em;
            color: #666;
        }

        h1 {
            font-family: 'Lora', Georgia, serif;
            font-weight: bold;
            font-size: 3em;
            line-height: 1.1;
        }

        h2 {
            font-family: 'Lora', Georgia, serif;
            font-weight: bold;
            font-size: 1.5em;
            line-height: 1.1;
        }

        .subhead {
            font-family: 'Lora', Georgia, serif;
        }

        iframe,
        img,
        video {
            max-width: 100%;
        }

        p {
            line-height: 1.6;
            margin: 0;
            padding-bottom: 1.2em;
        }

        ul {
            margin: 0;
            padding-bottom: 1em;
            line-height: 1.6;
        }

        iframe {
            padding-bottom: 1.2em;
        }

        code {
            font-family: 'Courier New', monospace;
            background: #fffbaf;
            font-size: 0.85em;
        }

        .full-width figure {
            text-align: center;
        }

        /* margin on mobile */
        @media (max-width: 640px) {
            body {
                font-size: 16px;
            }

            .content {
                padding-left: 0.5em;
                padding-right: 0.5em;
            }
        }

        /*scrollama related styles*/
        #scroll-content {
            position: relative;
            padding: 1rem;
        }

        #scroll-content #text {
            position: relative;
            padding: 0;
            max-width: 20rem;
            margin: 0 auto;
        }

        #scroll-content #svg-chart {
            position: sticky;
            left: 0;
            width: 100%;
            max-width: 640px;
            height: 80vh; /*adjustable height to screen*/
            margin: 0 auto;
            -webkit-transform: translate3d(0, 0, 0);
            -moz-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
            background-color: transparent;
            z-index: 0;
        }

        #scroll-content .step {
            margin: 0 auto 1rem auto;
            margin-bottom: 30rem;
            padding: 0.5rem 1rem;
            color: #fff;
            background-color: rgba(255, 255, 255, 0.8);
            color: black;
            width: fit-content;
            max-width: 100%;
            height: auto !important;
            min-height: 100px;
            max-height: auto;
            text-align: center;
            justify-content: center;
        }

    </style>
</head>

<body>
    <div class="content">
        <div class="header">
            <h1>3.768 Ecuadorians deported from the US since Trump took office</h1>
            <p class="subhead">bla bla bl da sda sd as da sd as d as da sf a f dhf dgh d fh dfg hd fgh dfg hd fhg dfgh df ghd fhg fd hd fgh fd gh dfg hdf ghdfg hdr  th drt hd rth dr thd r nx b xf b dfb cx vbx fv b cv b a bla.</p>
        </div>

        <div class="byline">
            <p>By <a href="https://twitter.com/EstefaniaCeliR", target="_blank">Estefan√≠a Celi</a></p>
        </div>
        
        <p>Data from The Deportation Data Project. dfsdzsdgdf gz dfg zfgzdgzd fgzd fgzzd fgdf gdzf gzdgzdfg zdfg zdf ge rgrse rgs serg serg ser gs erg ser g er gse rgr ser gs erg ser gs egr ser g serg se rg ser gse rgs erg se rgs erg se rg se rg</p>
        
        <div id="scroll-content">  <!-- The overall container -->
            <div id="svg-chart"></div> <!-- Your chart -->
            <div id="text"> 
                <div class="step">The majority of those being deported are not <span style="color: #e63946;"><strong>convicted criminals</strong></span> or <span style="color: #f1c40f;"><strong>pending criminal charges</strong></span>.</div>
                <div class="step">Most of them are young adults, in the groups <span style="color: #264653;"><strong>from 21 to 30 years old</strong></span>, and <span style="color: #48cae4;"><strong>from 31 to 40 years old</strong></span>.</div>
                <div class="step"><span style="color: #9d4edd;"><strong>Women</strong></span> are a minority between deported Ecuadorians.</div>
            </div> 
        </div>
    </div>
    <div class="footer">
        <div class="content">
            <p>Scrollytelling homework.</p>
        </div>
    </div>
</body>

</html>