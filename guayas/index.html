<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>En Guayas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css' rel='stylesheet' />
<script src="https://cdn.jsdelivr.net/npm/mapbox-gl-globe-minimap@1.2.0/dist/bundle.js"></script>
<script src="https://unpkg.com/scrollama"></script>
<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden; /* prevent iframe body scroll */
    font-family: sans-serif;
}
#story-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow-y: auto; /* scrollable inside iframe */
    -webkit-overflow-scrolling: touch;
}
#map {
    position: sticky; /* sticky inside iframe scroll */
    top: 0;
    width: 100%;
    height: 100vh;
    z-index: 0;
}
#features {
    padding-top: 20vh;
    padding-bottom: 20vh;
}
.step {
    min-height: 120vh; /* taller than viewport for smooth map animations */
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.25;
    transition: opacity 0.3s ease-out;
    padding: 0 20px;
    box-sizing: border-box;
}
.step.active { opacity: 1; }
.step-content {
    background: rgba(255,255,255,0.95);
    padding: 30px 40px;
    border-radius: 6px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    max-width: 800px;
    width: 90%;
    line-height: 1.5;
}
.step img { width: 100%; height: auto; }
@media(max-width:750px){
    .step-content { padding: 20px 15px; font-size: 14px; }
}
</style>
</head>
<body>

<div id="story-wrapper">
    <div id="map"></div>
    <div id="story">
        <div id="features"></div>
    </div>
</div>

<script src="./config.js"></script>
<script>
mapboxgl.accessToken = config.accessToken;

// Create the map
var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false,
    projection: config.projection
});

if(config.inset) map.addControl(new GlobeMinimap({...config.insetOptions}), config.insetPosition);
if(config.showMarkers) var marker = new mapboxgl.Marker({color: config.markerColor}).setLngLat(config.chapters[0].location.center).addTo(map);

// Build steps
var story = document.getElementById('features');
config.chapters.forEach((chap, idx) => {
    var container = document.createElement('div');
    container.className = 'step';
    container.id = chap.id;
    if(idx===0) container.classList.add('active');

    var content = document.createElement('div');
    content.className = 'step-content';
    if(chap.title){ var h = document.createElement('h3'); h.innerText = chap.title; content.appendChild(h); }
    if(chap.image){ var img = new Image(); img.src = chap.image; content.appendChild(img); }
    if(chap.description){ var p = document.createElement('p'); p.innerHTML = chap.description; content.appendChild(p); }

    container.appendChild(content);
    story.appendChild(container);
});

// Scrollama setup for iframe
var scroller = scrollama();
scroller.setup({
    step: '.step',
    container: '#story-wrapper', // IMPORTANT: scrollable container inside iframe
    offset: 0.5,
    progress: false
})
.onStepEnter(response => {
    var chap = config.chapters.find(c => c.id === response.element.id);
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    response.element.classList.add('active');

    map[chap.mapAnimation || 'flyTo'](chap.location);
    if(config.showMarkers) marker.setLngLat(chap.location.center);
    if(chap.onChapterEnter.length) chap.onChapterEnter.forEach(layer=>{
        var paintProps = Object.keys(map.getLayer(layer.layer).paint||{});
        paintProps.forEach(prop=>map.setPaintProperty(layer.layer, prop, layer.opacity));
    });
})
.onStepExit(response => {
    var chap = config.chapters.find(c => c.id === response.element.id);
    if(chap.onChapterExit.length) chap.onChapterExit.forEach(layer=>{
        var paintProps = Object.keys(map.getLayer(layer.layer).paint||{});
        paintProps.forEach(prop=>map.setPaintProperty(layer.layer, prop, layer.opacity));
    });
});

window.addEventListener('resize', scroller.resize);
</script>

</body>
</html>
